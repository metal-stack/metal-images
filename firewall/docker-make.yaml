---
version: '1'
name: firewall
username: metalstack
registry-host: quay.io
default-build-args:
  - http_proxy=${HTTP_PROXY}
  - https_proxy=${HTTP_PROXY}
  - HTTP_PROXY=${HTTP_PROXY}
  - HTTPS_PROXY=${HTTP_PROXY}
  - NO_PROXY=${NO_PROXY}
  - no_proxy=${NO_PROXY}
  - SEMVER_PATCH=${SEMVER_PATCH}
  - OS_NAME=firewall
builds:
  -
    name: debian
    tags:
      - ${SEMVER}
      - ${SEMVER_MAJOR_MINOR}
    build-args:
      - BASE_OS_VERSION=10
      - BASE_OS_NAME=quay.io/metalstack/debian
      - SEMVER_MAJOR_MINOR=2.0
      - SEMVER=${SEMVER_MAJOR_MINOR}${SEMVER_PATCH}
    after:
      # debian is currently not testable because of 
      #
      # openssh (1:8.1p1-5) unstable; urgency=medium
      # * Apply upstream patches to allow clock_nanosleep() and variants in the
      #   seccomp sandbox, fixing failures with glibc 2.31
      # s. https://metadata.ftp-master.debian.org/changelogs/main/o/openssh/testing_changelog
      #
      # with ssh to the test vm one gets an audit event for the clock_nanosleep syscall (230)
      # audit: type=1326 audit(1595317960.526:2): auid=4294967295 uid=107 gid=65534 ses=4294967295 subj=kernel pid=1177 comm="sshd" exe="/usr/sbin/sshd" sig=31 arch=c000003e syscall=230 compat=0 ip=0x7fc40d5eebea code=0x0
      #- cd ../ && OS_NAME=${OS_NAME} ./test.sh quay.io/metalstack/${OS_NAME}:${SEMVER}
      - OS_NAME=${OS_NAME} SEMVER_MAJOR_MINOR=${SEMVER_MAJOR_MINOR} SEMVER_PATCH=${SEMVER_PATCH} ../export.sh
  -
    name: ubuntu
    tags:
      - ${SEMVER}
      - ${SEMVER_MAJOR_MINOR}
    build-args:
      - BASE_OS_VERSION=19.10
      - BASE_OS_NAME=quay.io/metalstack/ubuntu
      - SEMVER_MAJOR_MINOR=2.0-ubuntu
      - SEMVER=${SEMVER_MAJOR_MINOR}${SEMVER_PATCH}
    after:
      - cd ../ && OS_NAME=${OS_NAME} ./test.sh quay.io/metalstack/${OS_NAME}:${SEMVER}
      - OS_NAME=${OS_NAME} SEMVER_MAJOR_MINOR=${SEMVER_MAJOR_MINOR} SEMVER_PATCH=${SEMVER_PATCH} ../export.sh
