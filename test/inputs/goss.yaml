---
user:
  metal:
    exists: true
{{ if eq .Env.MACHINE_TYPE "machine" }}
file:
  "/home/metal/.ssh/authorized_keys":
    exists: true
    contains:
    - {{ .Env.PUB_KEY }}
{{ end }}
service:
  frr:
    enabled: true
    running: true
  ssh:
    enabled: true
    running: true
{{ if eq .Env.MACHINE_TYPE "firewall" }}
  suricata:
    enabled: true
    running: true
  nftables:
    enabled: true
    running: true
{{ end }}
process:
  bgpd:
    running: true
  zebra:
    running: true
dns:
  google.com:
    resolvable: true
command:
  "hostname is set":
    exec: "hostnamectl --static"
    exit-status: 0
    stdout:
    - machine
  "lldpd is enabled":
    exec: "systemctl list-unit-files | grep enabled | grep lldpd"
    exit-status: 0
  "internet is reachable":
    exec: "ping -W 1 -c 1 -n 1.1.1.1"
    exit-status: 0
  "systemd: timer for logrotation exists":
    exec: "systemctl list-timers | grep logrotate"
    exit-status: 0
    stdout:
    - "logrotate.timer"
    - "logrotate.service"
  "systemd: no pending jobs":
    exec: systemctl list-jobs
    exit-status: 0
    stdout:
    - No jobs running.
  "systemd: no failed units":
    exec: systemctl list-units --failed --no-pager --no-legend
    exit-status: 0
    stdout:
    - ""
  "metal user: sudo is possible with the machine console password":
    exec: |
      su metal -c /bin/bash -c 'printf "test\n" | sudo --stdin -i id'
    exit-status: 0
    stdout:
    - "uid=0(root)"
{{if eq .Env.MACHINE_TYPE "machine"}}
  "boot-info contains kernel, initrd and cmdline":
    exec: |
      cat /etc/metal/boot-info.yaml | yq r - kernel && \
      cat /etc/metal/boot-info.yaml | yq r - initrd && \
      cat /etc/metal/boot-info.yaml | yq r - cmdline
    exit-status: 0
    stdout:
    - "!null"
  "bgp has two peers visibile":
    exec: "vtysh -c 'show bgp sum json' | jq '.ipv4Unicast.totalPeers'"
    exit-status: 0
    stdout:
    - "2"
  "bgp router-id matches":
    exec: "vtysh -c 'show bgp json' | jq '.routerId'"
    exit-status: 0
    stdout:
    - {{ .Env.ROUTER_ID }}
  "bgp ASN matches":
    exec: "vtysh -c 'show bgp json' | jq '.localAS'"
    exit-status: 0
    stdout:
    - {{ .Env.ASN }}
  "only ssh and bgpd is listening at 0.0.0.0":
    exec: "ss -4 -Hlntu src 0.0.0.0 | egrep -v '22|179' | wc -l"
    exit-status: 0
    stdout:
    - "0"
  "only ssh and bgpd is listening at [::]":
    exec: "ss -6 -Hlntu src [::] | egrep -v '22|179' | wc -l"
    exit-status: 0
    stdout:
    - "0"
  "timedatectl show -p NTPSynchronized":
    exit-status: 0
    stdout:
    - "NTPSynchronized=yes"
{{ end }}
{{ if eq .Env.MACHINE_TYPE "firewall" }}
  "only ssh,vxlan and bgpd is listening at 0.0.0.0":
    exec: "ss -4 -Hlntu src 0.0.0.0 | egrep -v '22|179|4789' | wc -l"
    exit-status: 0
    stdout:
    - "0"
  "only ssh,vxlan and bgpd is listening at [::]":
    exec: "ss -6 -Hlntu src [::] | egrep -v '22|179|4789' | wc -l"
    exit-status: 0
    stdout:
    - "0"
  "chronyc tracking":
    exit-status: 0
    stdout:
    - "Leap status     : Normal"
{{ end }}
kernel-param:
  net.ipv6.conf.all.disable_ipv6:
    value: "0"
  net.ipv6.conf.default.disable_ipv6:
    value: "0"
  net.ipv4.conf.all.rp_filter:
    value: "0"
  net.ipv4.conf.default.rp_filter:
    value: "0"
  